datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  OPERATOR
  AUDITOR
}

/// Auth-ready user model for auditing and access control.
model User {
  id           String   @id @default("SYSTEM") @db.VarChar(64)
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(OPERATOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reverse relations
  shipsCreated       Ship[]          @relation("ShipCreatedBy")
  shipsUpdated       Ship[]          @relation("ShipUpdatedBy")
  routesCreated      Route[]         @relation("RouteCreatedBy")
  routesUpdated      Route[]         @relation("RouteUpdatedBy")
  compliancesCreated ShipCompliance[] @relation("ComplianceCreatedBy")
  compliancesUpdated ShipCompliance[] @relation("ComplianceUpdatedBy")
  bankEntriesCreated BankEntry[]     @relation("BankCreatedBy")
  bankEntriesUpdated BankEntry[]     @relation("BankUpdatedBy")
  poolsCreated       Pool[]          @relation("PoolCreatedBy")
  poolsUpdated       Pool[]          @relation("PoolUpdatedBy")
  poolMembersCreated PoolMember[]    @relation("PoolMemberCreatedBy")
  poolMembersUpdated PoolMember[]    @relation("PoolMemberUpdatedBy")
}

/// Master data for a ship
model Ship {
  id   String  @id @db.VarChar(64)
  name String? @db.VarChar(255)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("ShipCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("ShipUpdatedBy", fields: [updatedById], references: [id])

  routes      Route[]
  compliances ShipCompliance[]
  bankEntries BankEntry[]
  poolMembers PoolMember[]

  @@index([id])
}

model Route {
  id              Int     @id @default(autoincrement())
  routeId         String  @unique
  shipId          String
  ship            Ship    @relation(fields: [shipId], references: [id])

  vesselType      String  @db.VarChar(64)
  fuelType        String  @db.VarChar(64)
  year            Int
  ghgIntensity    Float
  fuelConsumption Float
  distance        Float
  totalEmissions  Float
  isBaseline      Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("RouteCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("RouteUpdatedBy", fields: [updatedById], references: [id])

  @@index([year])
  @@index([shipId])
  @@index([routeId])
}

model ShipCompliance {
  id          Int     @id @default(autoincrement())
  shipId      String
  ship        Ship    @relation(fields: [shipId], references: [id])
  year        Int
  cbGco2eq    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("ComplianceCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("ComplianceUpdatedBy", fields: [updatedById], references: [id])

  @@unique([shipId, year])
  @@index([shipId, year])
}

model BankEntry {
  id          Int     @id @default(autoincrement())
  shipId      String
  ship        Ship    @relation(fields: [shipId], references: [id])
  year        Int
  amount      Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("BankCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("BankUpdatedBy", fields: [updatedById], references: [id])

  @@index([shipId, year])
}

model Pool {
  id          Int          @id @default(autoincrement())
  year        Int
  members     PoolMember[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("PoolCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("PoolUpdatedBy", fields: [updatedById], references: [id])

  @@index([year])
}

model PoolMember {
  id          Int     @id @default(autoincrement())
  poolId      Int
  pool        Pool    @relation(fields: [poolId], references: [id])
  shipId      String
  ship        Ship    @relation(fields: [shipId], references: [id])
  cbBefore    Float
  cbAfter     Float

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @default("SYSTEM")
  updatedById String   @default("SYSTEM")
  createdBy   User     @relation("PoolMemberCreatedBy", fields: [createdById], references: [id])
  updatedBy   User     @relation("PoolMemberUpdatedBy", fields: [updatedById], references: [id])

  @@index([poolId])
  @@index([shipId])
}
